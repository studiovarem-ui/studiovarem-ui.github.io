<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>VAREM • Word Fall Quiz</title>

  <style>
    :root{
      --bg:#000;
      --text:#fff;
      --card:#111;
      --shadow: rgba(0,0,0,.85);
      --ok:#22c55e;
      --bad:#ff4d4f;
    }
    *{box-sizing:border-box}

    /* ✅ 스크롤 완전 차단 */
    html, body{
      height:100%;
      margin:0;
      overflow:hidden;
      overscroll-behavior:none;
      background:var(--bg);
      color:var(--text);
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
      -webkit-font-smoothing:antialiased;
      touch-action: manipulation;
    }
    body{
      padding: 18px 14px 18px;
    }

    .wrap{
      height:100%;
      max-width: 980px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .brand{
      text-align:center;
      letter-spacing:.22em;
      font-weight:900;
      font-size:14px;
      opacity:.9;
      flex:0 0 auto;
    }

    /* 상단 HUD (DAY 삭제) */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      flex:0 0 auto;
    }
    .stat{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:#fff;
      color:#111;
      border:4px solid #000;
      box-shadow: 0 10px 0 var(--shadow);
      font-weight: 900;
      font-size:12px;
      white-space:nowrap;
    }

    /* ✅ 2분할 레이아웃 */
    .main{
      flex:1 1 auto;
      min-height:0; /* 중요: 내부 스크롤/넘침 방지 */
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:stretch;
    }

    /* 왼쪽: stage */
    .leftPanel{
      position:relative;
      border-radius:22px;
      overflow:hidden;
      min-height:0;
    }
    .stage{
      position:relative;
      height:100%;
      border-radius:22px;
      overflow:hidden;
      background: transparent;
    }
    .floor{
      position:absolute; left:0; right:0; bottom:0;
      height:14px;
      background: #111;
      border-top:4px solid #000;
    }
    .wordCard{
      position:absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 0px;
      min-width: 240px;
      padding: 16px 18px;
      border-radius: 22px;
      background: var(--card);
      border: 4px solid #000;
      box-shadow: 0 16px 0 var(--shadow), 0 26px 60px rgba(0,0,0,.45);
      text-align:center;
      user-select:none;
      will-change: top, transform;
    }
    .wordCard .label{
      font-size:12px;
      color:#fff;
      font-weight:900;
      letter-spacing:.18em;
      opacity:1;
    }
    .wordCard .word{
      margin-top:8px;
      font-size:44px;
      font-weight:900;
      letter-spacing:.01em;
      color:#fff;
    }
    .wordCard.good{
      outline: 4px solid rgba(34,197,94,.85);
      outline-offset: 2px;
    }
    .wordCard.bad{
      outline: 4px solid rgba(255,77,79,.85);
      outline-offset: 2px;
    }

    /* 오른쪽: choices + controls */
    .rightPanel{
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height:0;
    }
    .choices{
      display:grid;
      grid-template-rows: repeat(4, 1fr);
      gap: 12px;
      flex:1 1 auto;
      min-height:0;
    }
    button.choice{
      width:100%;
      appearance:none;
      border: 4px solid #000;
      border-radius: 18px;
      padding: 14px 16px;
      font-size: 20px;
      font-weight: 900;
      color:#111;
      cursor:pointer;
      box-shadow: 0 12px 0 var(--shadow), 0 18px 40px rgba(0,0,0,.35);
      background:#E5E7EB;
      text-align:left;
      letter-spacing:.01em;
      display:flex;
      align-items:center;
      justify-content:flex-start;
      user-select:none;
      transform:none; /* ✅ 삐뚤빼뚤 제거 */
    }
    button.choice:active{
      transform: translateY(6px);
      box-shadow: 0 6px 0 var(--shadow), 0 12px 26px rgba(0,0,0,.35);
    }
    button.choice[disabled]{cursor:default; opacity:.95;}
    button.choice.correct{
      outline: 3px solid rgba(255,255,255,.9);
      outline-offset: 3px;
    }
    button.choice.wrong{
      opacity:.88;
      filter: grayscale(.25);
    }

    .controls{
      display:flex;
      gap:10px;
      justify-content:space-between;
      flex:0 0 auto;
    }
    .btn{
      flex:1;
      border-radius: 999px;
      padding: 10px 14px;
      background:#fff;
      border:4px solid #000;
      color:#111;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 10px 0 var(--shadow);
    }
    .btn:active{
      transform: translateY(6px);
      box-shadow: 0 4px 0 var(--shadow);
    }

    .hint{
      flex:0 0 auto;
      color: rgba(255,255,255,.72);
      font-size: 12px;
      line-height: 1.35;
      padding: 2px 2px 0;
    }
    .kbd{
      font-family: ui-monospace,SFMono-Regular,Menlo,monospace;
      font-weight:900;
      font-size:12px;
      background:#111;
      border:2px solid #000;
      padding:2px 6px;
      border-radius:10px;
      color:#fff;
    }

    /* Game over modal */
    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.72);
      padding: 18px 14px;
      z-index: 50;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      color:#111;
      border:4px solid #000;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 18px 0 var(--shadow), 0 34px 80px rgba(0,0,0,.45);
    }
    .modal h2{margin:0 0 8px; font-size:20px; font-weight: 900;}
    .modal .sub{color:rgba(0,0,0,.72); font-size:13px; margin-bottom:12px; font-weight:800;}
    .scores{
      margin-top:10px;
      border-top:2px solid rgba(0,0,0,.15);
      padding-top:10px;
      font-size:13px;
      font-weight:800;
    }
    .scores ol{margin:8px 0 0; padding-left:18px; font-weight:800;}

    /* 모바일 세로: 2분할 -> 위/아래 */
    @media (max-width: 720px){
      body{padding: 14px 12px;}
      .main{
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
      }
      .choices{
        grid-template-rows: repeat(4, auto);
      }
      button.choice{
        border-radius: 999px; /* 모바일은 라벨 느낌 */
        font-size: 18px;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="brand">VAREM</div>

    <!-- ✅ DAY 삭제 -->
    <div class="topbar">
      <div class="stat">Score <span id="score">0</span></div>
      <div class="stat">Combo <span id="combo">0</span></div>
      <div class="stat">♥ <span id="life">3</span></div>
    </div>

    <!-- ✅ 2분할 -->
    <div class="main">
      <div class="leftPanel">
        <div class="stage" id="stage" aria-label="Game stage">
          <div class="wordCard" id="wordCard" role="group" aria-label="Falling word">
            <div class="label">WORD</div>
            <div class="word" id="wordText">ready</div>
          </div>
          <div class="floor"></div>
        </div>
      </div>

      <div class="rightPanel">
        <div class="choices" id="choices"></div>

        <div class="controls">
          <button class="btn" id="startBtn">Start</button>
          <button class="btn" id="restartBtn">Restart</button>
        </div>

        <div class="hint">
          규칙: 떨어지는 영단어의 <b>올바른 뜻</b>을 터치하세요. 바닥에 닿으면 ♥ 감소.<br/>
          데스크탑: <span class="kbd">1</span>~<span class="kbd">4</span> 키 선택 가능.
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h2 id="modalTitle">Game Over</h2>
      <div class="sub" id="modalSub">Your score: 0</div>
      <div style="display:flex; gap:10px; justify-content:space-between;">
        <button class="btn" id="playAgainBtn">Play again</button>
        <button class="btn" id="closeBtn">Close</button>
      </div>
      <div class="scores" id="scoreBox"></div>
    </div>
  </div>

  <script src="./data.js"></script>
  <script>
    // 스크롤/튕김 방지(특히 iOS)
    document.addEventListener('touchmove', (e) => {
      e.preventDefault();
    }, { passive:false });

    // ---------- KST day-of-year seed (로직은 남겨둠: daily shuffle용) ----------
    function getKSTDate() {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      return new Date(utc + 9 * 3600000);
    }
    function dayOfYearKST(d) {
      const start = new Date(d.getFullYear(), 0, 0);
      const diff = d - start;
      const oneDay = 86400000;
      return Math.floor(diff / oneDay);
    }

    // ---------- seeded RNG ----------
    function mulberry32(seed) {
      let t = seed >>> 0;
      return function() {
        t += 0x6D2B79F5;
        let x = Math.imul(t ^ (t >>> 15), 1 | t);
        x ^= x + Math.imul(x ^ (x >>> 7), 61 | x);
        return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
      };
    }

    // ---------- DOM ----------
    const scoreEl = document.getElementById("score");
    const comboEl = document.getElementById("combo");
    const lifeEl = document.getElementById("life");
    const stageEl = document.getElementById("stage");
    const wordCardEl = document.getElementById("wordCard");
    const wordTextEl = document.getElementById("wordText");
    const choicesEl = document.getElementById("choices");
    const startBtn = document.getElementById("startBtn");
    const restartBtn = document.getElementById("restartBtn");

    const overlay = document.getElementById("overlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalSub = document.getElementById("modalSub");
    const playAgainBtn = document.getElementById("playAgainBtn");
    const closeBtn = document.getElementById("closeBtn");
    const scoreBox = document.getElementById("scoreBox");

    // ---------- Game state ----------
    const WORDS = (window.WORDS || []).slice();
    if (!WORDS.length) alert("data.js에 WORDS가 비어있어요.");

    const kst = getKSTDate();
    const day = dayOfYearKST(kst);
    const rng = mulberry32((kst.getFullYear() * 1000) + day);

    function shuffleWithRng(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    const dailyList = shuffleWithRng(WORDS);

    let idx = 0;
    let running = false;
    let score = 0;
    let combo = 0;
    let life = 3;

    // physics
    let y = -90;
    let v = 0.02;     // px/ms
    let lastTs = null;

    // current question
    let current = null;
    let currentCorrect = null;
    let choiceButtons = [];

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function speedForScore(s) {
      const base = 0.02;
      const add  = Math.min(0.03, Math.floor(s / 120) * 0.004);
      return base + add;
    }

    function setHUD() {
      scoreEl.textContent = String(score);
      comboEl.textContent = String(combo);
      lifeEl.textContent = String(life);
    }

    function lockChoices(lock=true) {
      choiceButtons.forEach(b => b.disabled = lock);
    }

    function renderChoices(options) {
      const palette = ["#A7F3D0", "#FDE68A", "#FCA5A5", "#93C5FD"];

      choicesEl.innerHTML = "";
      choiceButtons = options.map((meaning, i) => {
        const b = document.createElement("button");
        b.className = "choice";
        b.type = "button";
        b.dataset.answer = meaning;

        // ✅ 이모지/삐뚤 제거: 고정 색만
        b.style.background = palette[i % palette.length];
        b.textContent = meaning;

        b.addEventListener("click", () => choose(meaning, b));
        choicesEl.appendChild(b);
        return b;
      });
    }

    function pickNextWord() {
      current = dailyList[idx % dailyList.length];
      idx++;

      const correct = current[1];
      const seen = new Set([correct]);
      const options = [correct];

      while (options.length < 4 && seen.size < WORDS.length) {
        const r = WORDS[Math.floor(rng() * WORDS.length)][1];
        if (!seen.has(r)) { seen.add(r); options.push(r); }
      }

      for (let i = options.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [options[i], options[j]] = [options[j], options[i]];
      }

      currentCorrect = correct;

      wordTextEl.textContent = String(current[0]).toLowerCase();

      // ✅ 삐뚤 제거 (회전 없음)
      wordCardEl.style.transform = `translateX(-50%)`;

      y = -90;
      v = speedForScore(score);
      wordCardEl.classList.remove("good","bad");

      renderChoices(options);
      lockChoices(false);
    }

    function choose(meaning, btn) {
      if (!running) return;
      lockChoices(true);

      const ok = (meaning === currentCorrect);
      if (ok) {
        combo += 1;
        const bonus = clamp(combo - 1, 0, 20);
        score += 10 + bonus;
        wordCardEl.classList.add("good");
        btn.classList.add("correct");
      } else {
        combo = 0;
        life -= 1;
        wordCardEl.classList.add("bad");
        btn.classList.add("wrong");
        choiceButtons.forEach(b => {
          if (b.dataset.answer === currentCorrect) b.classList.add("correct");
        });
      }

      setHUD();

      if (life <= 0) {
        endGame();
        return;
      }

      setTimeout(() => {
        if (!running) return;
        pickNextWord();
        setHUD();
      }, 520);
    }

    function endGame() {
      running = false;
      lockChoices(true);
      showModal("Game Over", `Your score: ${score}`);
      saveScore(score);
      renderTopScores();
    }

    function showModal(title, sub) {
      modalTitle.textContent = title;
      modalSub.textContent = sub;
      overlay.style.display = "flex";
    }

    function hideModal() {
      overlay.style.display = "none";
    }

    // Top5 local scores
    const SCORE_KEY = "vareM_wordfall_top5_v1";
    function loadScores() {
      try { return JSON.parse(localStorage.getItem(SCORE_KEY) || "[]"); }
      catch { return []; }
    }
    function saveScore(s) {
      const arr = loadScores();
      arr.push({ score: s, at: new Date().toISOString() });
      arr.sort((a,b)=>b.score-a.score);
      localStorage.setItem(SCORE_KEY, JSON.stringify(arr.slice(0,5)));
    }
    function renderTopScores() {
      const arr = loadScores();
      if (!arr.length) {
        scoreBox.innerHTML = "<b>Top 5</b><div style='margin-top:6px;opacity:.75'>No records yet.</div>";
        return;
      }
      const items = arr.map(x => `<li><b>${x.score}</b> <span style="opacity:.7">(${x.at.slice(0,10)})</span></li>`).join("");
      scoreBox.innerHTML = `<b>Top 5</b><ol>${items}</ol>`;
    }

    // animation loop
    function tick(ts) {
      if (!running) { lastTs = ts; requestAnimationFrame(tick); return; }
      if (lastTs == null) lastTs = ts;
      const dt = ts - lastTs;
      lastTs = ts;

      y += v * dt;
      wordCardEl.style.top = y + "px";

      const stageH = stageEl.clientHeight;
      const cardH = wordCardEl.offsetHeight;
      const floorY = stageH - 14;

      if (y + cardH >= floorY) {
        combo = 0;
        life -= 1;
        setHUD();

        wordCardEl.classList.add("bad");
        lockChoices(true);

        if (life <= 0) {
          endGame();
        } else {
          setTimeout(() => {
            if (!running) return;
            pickNextWord();
            setHUD();
          }, 520);
        }
      }

      requestAnimationFrame(tick);
    }

    function startGame() {
      score = 0; combo = 0; life = 3;
      idx = 0;
      running = true;
      setHUD();
      pickNextWord();
    }

    function restartGame() {
      hideModal();
      startGame();
    }

    // keyboard shortcuts 1~4
    window.addEventListener("keydown", (e) => {
      if (!running) return;
      const k = e.key;
      if (k >= "1" && k <= "4") {
        const i = Number(k) - 1;
        const b = choiceButtons[i];
        if (b && !b.disabled) b.click();
      }
    });

    startBtn.addEventListener("click", () => { hideModal(); startGame(); });
    restartBtn.addEventListener("click", restartGame);
    playAgainBtn.addEventListener("click", restartGame);
    closeBtn.addEventListener("click", hideModal);
    overlay.addEventListener("click", (e) => { if (e.target === overlay) hideModal(); });

    // init
    setHUD();
    renderTopScores();
    lockChoices(true);
    requestAnimationFrame(tick);
  </script>
</body>
</html>