<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>VAREM ‚Ä¢ Word Fall Quiz</title>

  <style>
    :root{
      --blue:#557CF3; --teal:#4BACC6; --gray:#A6A6A6;
      --bg:#000; --text:#fff; --muted:#c9c9c9;
      --danger:#ff4d4f; --ok:#22c55e;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif;
      background: var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      padding: 18px 14px 20px;
    }
    .wrap{max-width:520px;margin:0 auto}
    .brand{
      text-align:center;
      letter-spacing:.22em;
      font-weight:900;
      font-size:14px;
      margin-top:8px;
      margin-bottom:12px;
      opacity:.9;
    }

    /* board: minimal for sticker vibe */
    .board{
      background: transparent;
      border: none;
      border-radius: var(--radius);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }

    /* HUD sticker pills */
    .pill, .stat{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:#fff;
      color:#111;
      border:4px solid #000;
      box-shadow: 0 10px 0 rgba(0,0,0,.85);
      font-weight: 900;
      font-size:12px;
      white-space:nowrap;
    }
    .stats{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    /* stage bigger */
    .stage{
      position:relative;
      height: 520px;  /* Îçî ÌÅ¨Í≤å */
      border-radius: 22px;
      overflow:hidden;
      background: transparent;
    }

    .floor{
      position:absolute; left:0; right:0; bottom:0;
      height:14px;
      background: #111;
      border-top:4px solid #000;
    }

    /* word card sticker */
    .wordCard{
      position:absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 0px;
      min-width: 240px;
      padding: 16px 18px;
      border-radius: 22px;
      background: #111;
      border: 4px solid #000;
      box-shadow: 0 16px 0 rgba(0,0,0,.85), 0 26px 60px rgba(0,0,0,.45);
      text-align:center;
      user-select:none;
      will-change: top, transform;
    }
    .wordCard .label{
      font-size:12px;
      color:#fff;
      font-weight:900;
      letter-spacing:.18em;
      opacity:1;
    }
    .wordCard .word{
      margin-top:8px;
      font-size:42px;
      font-weight:900;
      letter-spacing:.01em;
      color:#fff;
    }
    .wordCard.good{
      outline: 4px solid rgba(34,197,94,.85);
      outline-offset: 2px;
    }
    .wordCard.bad{
      outline: 4px solid rgba(255,77,79,.85);
      outline-offset: 2px;
    }

    .controls{
      margin-top:14px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    /* choices: 1-column sticker labels */
    .choices{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    button.choice{
      appearance:none;
      border: 4px solid #000;
      border-radius: 999px;
      padding: 14px 18px;
      font-size: 18px;
      font-weight: 900;
      color:#111;
      cursor:pointer;
      box-shadow: 0 12px 0 rgba(0,0,0,.85), 0 18px 40px rgba(0,0,0,.35);
      transform-origin: center;
      min-height: 54px;
      text-align:left;
      letter-spacing: .01em;
    }
    button.choice:active{
      transform: translateY(6px) scale(.99) !important;
      box-shadow: 0 6px 0 rgba(0,0,0,.85), 0 12px 26px rgba(0,0,0,.35);
    }
    button.choice[disabled]{
      cursor: default;
      opacity:.95;
    }
    button.choice.correct{
      outline: 3px solid rgba(255,255,255,.9);
      outline-offset: 3px;
    }
    button.choice.wrong{
      opacity:.88;
      filter: grayscale(.25);
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .btn{
      border-radius: 999px;
      padding: 10px 14px;
      background:#fff;
      border:4px solid #000;
      color:#111;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 10px 0 rgba(0,0,0,.85);
    }
    .btn:active{
      transform: translateY(6px);
      box-shadow: 0 4px 0 rgba(0,0,0,.85);
    }

    .hint{
      color: rgba(255,255,255,.72);
      font-size: 12px;
      line-height: 1.35;
      padding: 2px 2px 0;
    }
    .kbd{
      font-family: ui-monospace,SFMono-Regular,Menlo,monospace;
      font-weight:900;
      font-size:12px;
      background:#111;
      border:2px solid #000;
      padding:2px 6px;
      border-radius:10px;
      color:#fff;
    }

    /* overlay */
    .overlay{
      position:fixed; inset:0;
      display:none;
      align-items:center; justify-content:center;
      background: rgba(0,0,0,.72);
      padding: 18px 14px;
    }
    .modal{
      width:min(520px, 100%);
      background:#fff;
      color:#111;
      border:4px solid #000;
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 18px 0 rgba(0,0,0,.85), 0 34px 80px rgba(0,0,0,.45);
    }
    .modal h2{margin:0 0 8px; font-size:20px; font-weight: 900;}
    .modal .sub{color:rgba(0,0,0,.72); font-size:13px; margin-bottom:12px; font-weight:800;}
    .scores{
      margin-top:10px;
      border-top:2px solid rgba(0,0,0,.15);
      padding-top:10px;
      font-size:13px;
      font-weight:800;
    }
    .scores ol{margin:8px 0 0; padding-left:18px; font-weight:800;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="brand">VAREM</div>

    <div class="board">
      <div class="topbar">
        <div class="pill" id="dayPill">DAY <span id="dayNum">‚Äî</span></div>
        <div class="stats">
          <div class="stat">Score <span id="score">0</span></div>
          <div class="stat">Combo <span id="combo">0</span></div>
          <div class="stat">‚ô• <span id="life">3</span></div>
        </div>
      </div>

      <div class="stage" id="stage" aria-label="Game stage">
        <div class="wordCard" id="wordCard" role="group" aria-label="Falling word">
          <div class="label">WORD</div>
          <div class="word" id="wordText">ready</div>
        </div>
        <div class="floor"></div>
      </div>

      <div class="controls">
        <div class="choices" id="choices"></div>

        <div class="row">
          <button class="btn" id="startBtn">Start</button>
          <button class="btn" id="restartBtn">Restart</button>
        </div>

        <div class="hint">
          Í∑úÏπô: Îñ®Ïñ¥ÏßÄÎäî ÏòÅÎã®Ïñ¥Ïùò <b>Ïò¨Î∞îÎ•∏ Îúª</b> Ïä§Ìã∞Ïª§Î•º ÌÑ∞ÏπòÌïòÏÑ∏Ïöî. Î∞îÎã•Ïóê ÎãøÏúºÎ©¥ ‚ô• Í∞êÏÜå.<br/>
          Îç∞Ïä§ÌÅ¨ÌÉë: <span class="kbd">1</span>~<span class="kbd">4</span> ÌÇ§ ÏÑ†ÌÉù Í∞ÄÎä•.
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h2 id="modalTitle">Game Over</h2>
      <div class="sub" id="modalSub">Your score: 0</div>
      <div class="row">
        <button class="btn" id="playAgainBtn">Play again</button>
        <button class="btn" id="closeBtn">Close</button>
      </div>
      <div class="scores" id="scoreBox"></div>
    </div>
  </div>

  <script src="./data.js"></script>
  <script>
    // ---------- KST day-of-year seed ----------
    function getKSTDate() {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      return new Date(utc + 9 * 3600000);
    }
    function dayOfYearKST(d) {
      const start = new Date(d.getFullYear(), 0, 0);
      const diff = d - start;
      const oneDay = 86400000;
      return Math.floor(diff / oneDay);
    }

    // ---------- seeded RNG ----------
    function mulberry32(seed) {
      let t = seed >>> 0;
      return function() {
        t += 0x6D2B79F5;
        let x = Math.imul(t ^ (t >>> 15), 1 | t);
        x ^= x + Math.imul(x ^ (x >>> 7), 61 | x);
        return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
      };
    }

    // ---------- DOM ----------
    const dayNumEl = document.getElementById("dayNum");
    const scoreEl = document.getElementById("score");
    const comboEl = document.getElementById("combo");
    const lifeEl = document.getElementById("life");
    const stageEl = document.getElementById("stage");
    const wordCardEl = document.getElementById("wordCard");
    const wordTextEl = document.getElementById("wordText");
    const choicesEl = document.getElementById("choices");
    const startBtn = document.getElementById("startBtn");
    const restartBtn = document.getElementById("restartBtn");

    const overlay = document.getElementById("overlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalSub = document.getElementById("modalSub");
    const playAgainBtn = document.getElementById("playAgainBtn");
    const closeBtn = document.getElementById("closeBtn");
    const scoreBox = document.getElementById("scoreBox");

    // ---------- Game state ----------
    const WORDS = (window.WORDS || []).slice();
    if (!WORDS.length) alert("data.jsÏóê WORDSÍ∞Ä ÎπÑÏñ¥ÏûàÏñ¥Ïöî.");

    const kst = getKSTDate();
    const day = dayOfYearKST(kst);
    dayNumEl.textContent = String(day);

    const rng = mulberry32((kst.getFullYear() * 1000) + day);

    function shuffleWithRng(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    const dailyList = shuffleWithRng(WORDS);

    let idx = 0;
    let running = false;
    let score = 0;
    let combo = 0;
    let life = 3;

    // physics
    let y = -90;      // ÌôîÎ©¥ ÏúÑÏóêÏÑú Îì±Ïû•
    let v = 0.02;     // px/ms
    let lastTs = null;

    // current question
    let current = null;         // [eng, kor]
    let currentCorrect = null;  // kor string
    let choiceButtons = [];

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function speedForScore(s) {
      // ÎäêÎ¶¨Í≤å ÏãúÏûë + Ï†êÏàòÏóê Îî∞Îùº ÏïÑÏ£º ÏÑúÏÑúÌûà Í∞ÄÏÜç
      const base = 0.02;
      const add  = Math.min(0.03, Math.floor(s / 120) * 0.004);
      return base + add;
    }

    function setHUD() {
      scoreEl.textContent = String(score);
      comboEl.textContent = String(combo);
      lifeEl.textContent = String(life);
    }

    function lockChoices(lock=true) {
      choiceButtons.forEach(b => b.disabled = lock);
    }

    function renderChoices(options) {
      const palette = [
        "#A7F3D0", "#FDE68A", "#FCA5A5", "#93C5FD",
        "#FBCFE8", "#C7D2FE", "#86EFAC", "#FFD54A"
      ];
      const icons = ["‚ú®", "‚≠êÔ∏è", "üêæ", "üî•", "üíé", "üçÄ"];

      choicesEl.innerHTML = "";
      choiceButtons = options.map((meaning) => {
        const b = document.createElement("button");
        b.className = "choice";
        b.type = "button";

        // store real answer (important because we add icon to text)
        b.dataset.answer = meaning;

        const color = palette[Math.floor(rng() * palette.length)];
        const tilt = (rng() * 10 - 5).toFixed(2);      // -5 ~ +5deg
        const scale = (0.98 + rng() * 0.08).toFixed(3); // 0.98~1.06
        b.style.background = color;
        b.style.transform = `rotate(${tilt}deg) scale(${scale})`;

        const icon = icons[Math.floor(rng() * icons.length)];
        b.textContent = `${icon}  ${meaning}`;

        b.addEventListener("click", () => choose(meaning, b));
        choicesEl.appendChild(b);
        return b;
      });
    }

    function pickNextWord() {
      current = dailyList[idx % dailyList.length];
      idx++;

      const correct = current[1];
      const seen = new Set([correct]);
      const options = [correct];

      while (options.length < 4 && seen.size < WORDS.length) {
        const r = WORDS[Math.floor(rng() * WORDS.length)][1];
        if (!seen.has(r)) { seen.add(r); options.push(r); }
      }

      // shuffle options
      for (let i = options.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [options[i], options[j]] = [options[j], options[i]];
      }

      currentCorrect = correct;

      // render word
      wordTextEl.textContent = String(current[0]).toLowerCase();

      // card tilt (sticker vibe)
      const tilt = (rng() * 6 - 3).toFixed(2);
      wordCardEl.style.transform = `translateX(-50%) rotate(${tilt}deg)`;

      // reset physics & styles
      y = -90;
      v = speedForScore(score);
      wordCardEl.classList.remove("good","bad");

      renderChoices(options);
      lockChoices(false);
    }

    function choose(meaning, btn) {
      if (!running) return;
      lockChoices(true);

      const ok = (meaning === currentCorrect);
      if (ok) {
        combo += 1;
        const bonus = clamp(combo - 1, 0, 20);
        score += 10 + bonus;
        wordCardEl.classList.add("good");
        btn.classList.add("correct");
      } else {
        combo = 0;
        life -= 1;
        wordCardEl.classList.add("bad");
        btn.classList.add("wrong");
        // show correct
        choiceButtons.forEach(b => {
          if (b.dataset.answer === currentCorrect) b.classList.add("correct");
        });
      }

      setHUD();

      if (life <= 0) {
        endGame();
        return;
      }

      setTimeout(() => {
        if (!running) return;
        pickNextWord();
        setHUD();
      }, 520);
    }

    function endGame() {
      running = false;
      lockChoices(true);
      showModal("Game Over", `Your score: ${score}`);
      saveScore(score);
      renderTopScores();
    }

    function showModal(title, sub) {
      modalTitle.textContent = title;
      modalSub.textContent = sub;
      overlay.style.display = "flex";
    }

    function hideModal() {
      overlay.style.display = "none";
    }

    // Top5 local scores
    const SCORE_KEY = "vareM_wordfall_top5_v1";
    function loadScores() {
      try { return JSON.parse(localStorage.getItem(SCORE_KEY) || "[]"); }
      catch { return []; }
    }
    function saveScore(s) {
      const arr = loadScores();
      arr.push({ score: s, at: new Date().toISOString() });
      arr.sort((a,b)=>b.score-a.score);
      localStorage.setItem(SCORE_KEY, JSON.stringify(arr.slice(0,5)));
    }
    function renderTopScores() {
      const arr = loadScores();
      if (!arr.length) {
        scoreBox.innerHTML = "<b>Top 5</b><div style='margin-top:6px;opacity:.75'>No records yet.</div>";
        return;
      }
      const items = arr.map(x => `<li><b>${x.score}</b> <span style="opacity:.7">(${x.at.slice(0,10)})</span></li>`).join("");
      scoreBox.innerHTML = `<b>Top 5</b><ol>${items}</ol>`;
    }

    // animation loop
    function tick(ts) {
      if (!running) { lastTs = ts; requestAnimationFrame(tick); return; }
      if (lastTs == null) lastTs = ts;
      const dt = ts - lastTs;
      lastTs = ts;

      y += v * dt;
      wordCardEl.style.top = y + "px";

      const stageH = stageEl.clientHeight;
      const cardH = wordCardEl.offsetHeight;
      const floorY = stageH - 14; // floor height

      if (y + cardH >= floorY) {
        // missed
        combo = 0;
        life -= 1;
        setHUD();

        wordCardEl.classList.add("bad");
        lockChoices(true);

        if (life <= 0) {
          endGame();
        } else {
          setTimeout(() => {
            if (!running) return;
            pickNextWord();
            setHUD();
          }, 520);
        }
      }

      requestAnimationFrame(tick);
    }

    function startGame() {
      score = 0; combo = 0; life = 3;
      idx = 0;
      running = true;
      setHUD();
      pickNextWord();
    }

    function restartGame() {
      hideModal();
      startGame();
    }

    // keyboard shortcuts 1~4
    window.addEventListener("keydown", (e) => {
      if (!running) return;
      const k = e.key;
      if (k >= "1" && k <= "4") {
        const i = Number(k) - 1;
        const b = choiceButtons[i];
        if (b && !b.disabled) b.click();
      }
    });

    startBtn.addEventListener("click", () => { hideModal(); startGame(); });
    restartBtn.addEventListener("click", restartGame);
    playAgainBtn.addEventListener("click", restartGame);
    closeBtn.addEventListener("click", hideModal);
    overlay.addEventListener("click", (e) => { if (e.target === overlay) hideModal(); });

    // init
    setHUD();
    renderTopScores();
    lockChoices(true);
    requestAnimationFrame(tick);
  </script>
</body>
</html>