const canvas=document.getElementById('gameCanvas'),ctx=canvas.getContext('2d');ctx.imageSmoothingEnabled=false;let scale=1;const BASE_WIDTH=800,BASE_HEIGHT=500;function resizeCanvas(){const container=document.getElementById('gameArea'),cw=container.clientWidth,ch=container.clientHeight,scaleX=cw/BASE_WIDTH,scaleY=ch/BASE_HEIGHT;scale=Math.min(scaleX,scaleY);canvas.width=BASE_WIDTH*scale;canvas.height=BASE_HEIGHT*scale;canvas.style.width=canvas.width+'px';canvas.style.height=canvas.height+'px';ctx.setTransform(scale,0,0,scale,0,0);ctx.imageSmoothingEnabled=false;const isMobile='ontouchstart'in window||navigator.maxTouchPoints>0;if(isMobile)document.body.classList.add('mobile-visible');else document.body.classList.remove('mobile-visible')}window.addEventListener('resize',resizeCanvas);window.addEventListener('orientationchange',()=>setTimeout(resizeCanvas,100));const SPRITES={sparrow:['................','......####......','.....#8888#.....','....#888888#....','...#88FF888#W...','...#88FF888WW...','..#8888888O#....','..#8O888888#....','..#88888888#....','.#8888888888#...','.#88#8888#88#...','..##.#88#.##....','.....#88#.......','.....#..#.......','.....O..O.......','................'],pigeon:['................','.....#####......','....#GGGGG#.....','...#GGGGGGG#....','...#GGFFGGG#W...','...#GGFFGGGWW...','..#PPPPPPPP#....','..#POGGGGGG#....','..#GGGGGGGG#....','.#GGGGGGGGGG#...','.#GG#GGGG#GG#...','..##.#GG#.##....','.....#GG#.......','.....#..#.......','.....R..R.......','................'],crow:['................','.....#####......','....#00000#.....','...#0000000#....','...#00FF000#W...','...#00FF000WW...','..#0000000O#....','..#0O000000#....','..#00000000#....','.#0000000000#...','.#00#0000#00#...','..##.#00#.##....','.....#00#.......','.....#..#.......','.....0..0.......','................'],poop:['........','...##...','..####..','.##8###.','.######.','########','########','.######.']};const COLORS={'#':'#1a1a2e','8':'#8B4513','F':'#FFD700','W':'#FFFFFF','O':'#FF6600','G':'#708090','P':'#9370DB','R':'#DC143C','0':'#1a1a2e','.':null};const spriteCanvases={};function createSpriteCanvas(data,spriteScale=3){const h=data.length,w=data[0].length,c=document.createElement('canvas');c.width=w*spriteScale;c.height=h*spriteScale;const x=c.getContext('2d');x.imageSmoothingEnabled=false;for(let y=0;y<h;y++)for(let i=0;i<w;i++){const ch=data[y][i];if(COLORS[ch]){x.fillStyle=COLORS[ch];x.fillRect(i*spriteScale,y*spriteScale,spriteScale,spriteScale)}}return c}function initSprites(){Object.keys(SPRITES).forEach(k=>spriteCanvases[k]=createSpriteCanvas(SPRITES[k],3))}function drawMenuBird(){const preview=document.getElementById('birdPreview'),pctx=preview.getContext('2d');pctx.clearRect(0,0,56,56);pctx.shadowColor='#FF6B9D';pctx.shadowBlur=10;if(spriteCanvases['sparrow'])pctx.drawImage(spriteCanvases['sparrow'],4,4)}const BIRDS={sparrow:{name:'Ï∞∏ÏÉà',sprite:'sparrow',speed:5,damage:1,poopCooldown:500,price:0},pigeon:{name:'ÎπÑÎëòÍ∏∞',sprite:'pigeon',speed:4.5,damage:2,poopCooldown:600,price:10},crow:{name:'ÍπåÎßàÍ∑Ä',sprite:'crow',speed:5.5,damage:3,poopCooldown:400,price:20}};const ITEMS={healFood:{name:'ÌöåÎ≥µ',icon:'üçû',price:30,desc:'HP +1'},laxative:{name:'ÏÑ§ÏÇ¨ÏïΩ',icon:'üíä',price:50,desc:'Î¨¥Ìïú'},shield:{name:'Î∞©Ïñ¥Îßâ',icon:'üõ°Ô∏è',price:60,desc:'1Ìöå'},poopBomb:{name:'Ìè≠ÌÉÑ',icon:'üí£',price:100,desc:'Í¥ëÏó≠'}};const UPGRADES={poopCapacity:{name:'Îò• Ï£ºÎ®∏Îãà',icon:'üí∞',price:3,desc:'+20%',maxLevel:5},digestion:{name:'ÏÜåÌôîÎ†•',icon:'‚ö°',price:4,desc:'+15%',maxLevel:5},wingPower:{name:'ÎÇ†Í∞ú',icon:'ü¶Ö',price:5,desc:'+10%',maxLevel:5}};const STAGES={1:{name:'Ïù∏ÎèÑ',targetScore:200,duration:60,spawnRate:2000,boss:'cleaner'},2:{name:'Í≥µÏõê',targetScore:350,duration:75,spawnRate:1600,boss:'gymBro'}};const BOSSES={cleaner:{name:'ÌôòÍ≤ΩÎØ∏ÌôîÏõê',health:5,score:200,feathers:30,goldenFeathers:1},gymBro:{name:'Ìó¨Ï∞Ω',health:7,score:300,feathers:50,goldenFeathers:2}};let gameState={screen:'menu',currentStage:1,score:0,feathers:100,goldenFeathers:5,health:3,maxHealth:3,poopGauge:100,maxPoopGauge:100,combo:0,hits:0,shots:0,time:0,bossSpawned:false,bossDefeated:false,stageFeathers:0,stageGoldenFeathers:0,inventory:{healFood:2,laxative:1,shield:1,poopBomb:0},quickSlots:['healFood','laxative','shield','poopBomb'],effects:{laxative:0,tripleShot:0,shield:false,invincible:0},upgrades:{poopCapacity:0,digestion:0,wingPower:0},currentBird:'sparrow',unlockedBirds:['sparrow'],stageStars:{1:0,2:0}};let bird={x:400,y:80,width:48,height:48},poops=[],humans=[],projectiles=[],particles=[],stars=[],boss=null,keys={},lastPoopTime=0,lastSpawnTime=0,gameStartTime=0,animationId=null,previousScreen='menu',joystick={active:false,startX:0,startY:0,moveX:0,moveY:0},poopPressed=false;function generateStars(){stars=[];for(let i=0;i<40;i++)stars.push({x:Math.random()*800,y:Math.random()*250,size:Math.random()*2+1,twinkle:Math.random()*Math.PI*2})}document.addEventListener('keydown',e=>{keys[e.code]=true;if(e.code==='Escape')togglePause();if(gameState.screen==='playing'){if(e.code==='Digit1')useQuickSlot(0);if(e.code==='Digit2')useQuickSlot(1);if(e.code==='Digit3')useQuickSlot(2);if(e.code==='Digit4')useQuickSlot(3)}});document.addEventListener('keyup',e=>keys[e.code]=false);const joystickArea=document.getElementById('joystickArea'),joystickKnob=document.getElementById('joystickKnob');function handleJoystickStart(e){e.preventDefault();const touch=e.touches?e.touches[0]:e,rect=joystickArea.getBoundingClientRect();joystick.active=true;joystick.startX=rect.left+rect.width/2;joystick.startY=rect.top+rect.height/2}function handleJoystickMove(e){if(!joystick.active)return;e.preventDefault();const touch=e.touches?e.touches[0]:e,dx=touch.clientX-joystick.startX,dy=touch.clientY-joystick.startY,maxDist=35,dist=Math.min(Math.sqrt(dx*dx+dy*dy),maxDist),angle=Math.atan2(dy,dx);joystick.moveX=(dist/maxDist)*Math.cos(angle);joystick.moveY=(dist/maxDist)*Math.sin(angle);const knobX=joystick.moveX*maxDist,knobY=joystick.moveY*maxDist;joystickKnob.style.transform=`translate(calc(-50% + ${knobX}px), calc(-50% + ${knobY}px))`}function handleJoystickEnd(){joystick.active=false;joystick.moveX=0;joystick.moveY=0;joystickKnob.style.transform='translate(-50%, -50%)'}joystickArea.addEventListener('touchstart',handleJoystickStart,{passive:false});joystickArea.addEventListener('touchmove',handleJoystickMove,{passive:false});joystickArea.addEventListener('touchend',handleJoystickEnd);joystickArea.addEventListener('touchcancel',handleJoystickEnd);const poopButton=document.getElementById('poopButton');poopButton.addEventListener('touchstart',e=>{e.preventDefault();poopPressed=true},{passive:false});poopButton.addEventListener('touchend',()=>poopPressed=false);poopButton.addEventListener('touchcancel',()=>poopPressed=false);document.querySelectorAll('.item-btn').forEach(btn=>{btn.addEventListener('touchstart',e=>{e.preventDefault();useQuickSlot(parseInt(btn.dataset.slot))},{passive:false})});function updateItemButtons(){document.querySelectorAll('.item-btn').forEach((btn,i)=>{const k=gameState.quickSlots[i];if(k&&ITEMS[k]){btn.querySelector('.icon').textContent=ITEMS[k].icon;btn.querySelector('.count').textContent=gameState.inventory[k]||0}})}function togglePause(){if(gameState.screen==='playing')pauseGame();else if(gameState.screen==='paused')resumeGame()}function hideAllOverlays(){document.getElementById('mainMenu').classList.remove('active');['stageSelect','shopOverlay','stageClearOverlay','gameoverOverlay','pauseOverlay'].forEach(id=>document.getElementById(id).classList.remove('active'))}function showMainMenu(){gameState.screen='menu';hideAllOverlays();document.getElementById('mainMenu').classList.add('active');if(animationId)cancelAnimationFrame(animationId);drawMenuBird()}function showStageSelect(){gameState.screen='stageSelect';hideAllOverlays();document.getElementById('stageSelect').classList.add('active');updateStageStars();const s2=document.getElementById('stage2Btn'),lock=document.getElementById('stage2Lock');if(gameState.stageStars[1]>0){s2.classList.remove('locked');lock.style.display='none'}else{s2.classList.add('locked');lock.style.display='block'}}function updateStageStars(){[1,2].forEach(i=>{const s=gameState.stageStars[i];document.getElementById(`stage${i}Stars`).textContent='‚òÖ'.repeat(s)+'‚òÜ'.repeat(3-s)})}function quitToMenu(){if(animationId)cancelAnimationFrame(animationId);showStageSelect()}function startStage(num){if(num===2&&gameState.stageStars[1]===0){showNotification('STAGE 1 ÌÅ¥Î¶¨Ïñ¥ ÌïÑÏöî!');return}gameState.currentStage=num;gameState.screen='playing';gameState.score=0;gameState.health=gameState.maxHealth;gameState.poopGauge=gameState.maxPoopGauge;gameState.combo=0;gameState.hits=0;gameState.shots=0;gameState.bossSpawned=false;gameState.bossDefeated=false;gameState.stageFeathers=0;gameState.stageGoldenFeathers=0;gameState.effects={laxative:0,tripleShot:0,shield:false,invincible:0};bird.x=400;bird.y=80;poops=[];humans=[];projectiles=[];particles=[];boss=null;generateStars();gameStartTime=Date.now();lastSpawnTime=0;hideAllOverlays();updateItemButtons();gameLoop()}function retryStage(){startStage(gameState.currentStage)}function pauseGame(){gameState.screen='paused';document.getElementById('pauseOverlay').classList.add('active')}function resumeGame(){gameState.screen='playing';document.getElementById('pauseOverlay').classList.remove('active');gameLoop()}function openShop(){previousScreen=gameState.screen;gameState.screen='shop';hideAllOverlays();document.getElementById('shopOverlay').classList.add('active');updateShopDisplay();switchShopTab(document.querySelector('.shop-tab'),'consumables')}function openShopFromMenu(){previousScreen='menu';openShop()}function openShopFromPause(){previousScreen='paused';document.getElementById('pauseOverlay').classList.remove('active');openShop()}function closeShop(){document.getElementById('shopOverlay').classList.remove('active');if(previousScreen==='paused'){gameState.screen='paused';document.getElementById('pauseOverlay').classList.add('active')}else showStageSelect()}function updateShopDisplay(){document.getElementById('shopFeathers').textContent=gameState.feathers;document.getElementById('shopGoldenFeathers').textContent=gameState.goldenFeathers}function switchShopTab(el,tab){document.querySelectorAll('.shop-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');const container=document.getElementById('shopItems');container.innerHTML='';if(tab==='consumables'){Object.entries(ITEMS).forEach(([k,item])=>{const owned=gameState.inventory[k]||0,div=document.createElement('div');div.className='shop-item';div.innerHTML=`<div class="shop-item-icon">${item.icon}</div><div class="shop-item-name">${item.name}</div><div class="shop-item-desc">${item.desc}</div><div class="shop-item-desc">Î≥¥Ïú†: ${owned}</div><div class="shop-item-price">ü™∂ ${item.price}</div>`;div.onclick=()=>buyItem(k);container.appendChild(div)})}else if(tab==='upgrades'){Object.entries(UPGRADES).forEach(([k,up])=>{const lv=gameState.upgrades[k],maxed=lv>=up.maxLevel,div=document.createElement('div');div.className=`shop-item ${maxed?'owned':''}`;div.innerHTML=`<div class="shop-item-icon">${up.icon}</div><div class="shop-item-name">${up.name}</div><div class="shop-item-desc">${up.desc}</div><div class="shop-item-desc">Lv.${lv}/${up.maxLevel}</div><div class="shop-item-price golden">${maxed?'MAX':`‚ú¶ ${up.price}`}</div>`;if(!maxed)div.onclick=()=>buyUpgrade(k);container.appendChild(div)})}else if(tab==='birds'){Object.entries(BIRDS).forEach(([k,b])=>{const owned=gameState.unlockedBirds.includes(k),sel=gameState.currentBird===k,div=document.createElement('div');div.className=`shop-item ${owned&&sel?'owned':''}`;div.innerHTML=`<div class="shop-item-icon" style="font-size:36px;">üê¶</div><div class="shop-item-name">${b.name}</div><div class="shop-item-desc">SPD:${b.speed} DMG:${b.damage}</div><div class="shop-item-price golden">${owned?(sel?'ÏÑ†ÌÉùÎê®':'ÏÑ†ÌÉù'):`‚ú¶ ${b.price}`}</div>`;div.onclick=()=>{if(owned){gameState.currentBird=k;switchShopTab(el,'birds');showNotification(`${b.name} ÏÑ†ÌÉù!`)}else buyBird(k)};container.appendChild(div)})}}function buyItem(k){const item=ITEMS[k];if(gameState.feathers>=item.price){gameState.feathers-=item.price;gameState.inventory[k]=(gameState.inventory[k]||0)+1;updateShopDisplay();switchShopTab(document.querySelector('.shop-tab.active'),'consumables');showNotification(`${item.name} Íµ¨Îß§!`)}else showNotification('ÍπÉÌÑ∏ Î∂ÄÏ°±!')}function buyUpgrade(k){const up=UPGRADES[k];if(gameState.goldenFeathers>=up.price&&gameState.upgrades[k]<up.maxLevel){gameState.goldenFeathers-=up.price;gameState.upgrades[k]++;if(k==='poopCapacity')gameState.maxPoopGauge=100+gameState.upgrades[k]*20;updateShopDisplay();switchShopTab(document.querySelector('.shop-tab.active'),'upgrades');showNotification(`${up.name} UP!`)}else showNotification('Ìô©Í∏àÍπÉÌÑ∏ Î∂ÄÏ°±!')}function buyBird(k){const b=BIRDS[k];if(gameState.goldenFeathers>=b.price){gameState.goldenFeathers-=b.price;gameState.unlockedBirds.push(k);gameState.currentBird=k;updateShopDisplay();switchShopTab(document.querySelector('.shop-tab.active'),'birds');showNotification(`${b.name} Ìï¥Í∏à!`)}else showNotification('Ìô©Í∏àÍπÉÌÑ∏ Î∂ÄÏ°±!')}function useQuickSlot(i){const k=gameState.quickSlots[i];if(!k||!gameState.inventory[k])return;gameState.inventory[k]--;updateItemButtons();switch(k){case'healFood':gameState.health=Math.min(gameState.health+1,gameState.maxHealth);showNotification('HP +1!');createParticles(bird.x,bird.y,'#FF6B9D',10);break;case'laxative':gameState.effects.laxative=Date.now()+10000;showNotification('UNLIMITED!');break;case'shield':gameState.effects.shield=true;showNotification('SHIELD!');break;case'poopBomb':activatePoopBomb();break}}function activatePoopBomb(){showNotification('üí£ BOOM!');humans.forEach(h=>{h.hit=true;gameState.score+=20;gameState.stageFeathers+=2;createParticles(h.x,h.y,'#8B4513',10)});if(boss&&!boss.defeated){boss.health-=2;createParticles(boss.x,boss.y,'#FF6B9D',20)}createParticles(400,250,'#FBBF24',30)}function spawnHuman(){const side=Math.random()<0.5?'left':'right',types=['normal','child','drunk'],type=types[Math.floor(Math.random()*types.length)],speeds={normal:1.5,child:2.5,drunk:1.8},scores={normal:10,child:30,drunk:25};humans.push({x:side==='left'?-30:830,y:380+Math.random()*60,width:30,height:45,type,speed:speeds[type],score:scores[type],direction:side==='left'?1:-1,hit:false,zigzagTimer:0,randomTimer:0})}function spawnBoss(){const stage=STAGES[gameState.currentStage],bossData=BOSSES[stage.boss];boss={x:400,y:400,width:50,height:60,...bossData,currentHealth:bossData.health,defeated:false,attackTimer:0,direction:1};showNotification(`‚ö† BOSS: ${bossData.name}!`)}function update(){if(gameState.screen!=='playing')return;const currentBird=BIRDS[gameState.currentBird],speedBonus=1+gameState.upgrades.wingPower*0.1,speed=currentBird.speed*speedBonus;if(keys['ArrowLeft']||keys['KeyA'])bird.x-=speed;if(keys['ArrowRight']||keys['KeyD'])bird.x+=speed;if(keys['ArrowUp']||keys['KeyW'])bird.y-=speed;if(keys['ArrowDown']||keys['KeyS'])bird.y+=speed;if(joystick.active){bird.x+=joystick.moveX*speed;bird.y+=joystick.moveY*speed}bird.x=Math.max(30,Math.min(770,bird.x));bird.y=Math.max(30,Math.min(160,bird.y));const now=Date.now(),isLaxative=gameState.effects.laxative>now,shouldShoot=keys['Space']||poopPressed;if(shouldShoot&&(now-lastPoopTime>currentBird.poopCooldown||isLaxative)){if(gameState.poopGauge>=10||isLaxative){shootPoop();lastPoopTime=now;if(!isLaxative)gameState.poopGauge-=10}}const regenBonus=1+gameState.upgrades.digestion*0.15;gameState.poopGauge=Math.min(gameState.maxPoopGauge,gameState.poopGauge+15*regenBonus/60);if(gameState.effects.invincible>0)gameState.effects.invincible--;gameState.time=Math.floor((now-gameStartTime)/1000);const stage=STAGES[gameState.currentStage];if(now-lastSpawnTime>stage.spawnRate&&!boss){spawnHuman();lastSpawnTime=now}if(gameState.time>=stage.duration&&!gameState.bossSpawned){gameState.bossSpawned=true;spawnBoss()}poops.forEach(p=>{p.y+=p.speed;p.rotation+=0.15});poops=poops.filter(p=>p.y<500);humans.forEach(h=>{if(h.hit)return;if(h.type==='child'){h.randomTimer++;if(h.randomTimer>30){h.direction=Math.random()<0.3?-h.direction:h.direction;h.randomTimer=0}}if(h.type==='drunk'){h.zigzagTimer++;h.y+=Math.sin(h.zigzagTimer*0.1)*2;if(Math.random()<0.003)projectiles.push({x:h.x,y:h.y-30,vx:(bird.x-h.x)*0.02,vy:-5})}h.x+=h.speed*h.direction});humans=humans.filter(h=>h.x>-50&&h.x<850&&!h.hit);if(boss&&!boss.defeated){boss.x+=1.2*boss.direction;if(boss.x<100||boss.x>700)boss.direction*=-1;boss.attackTimer++;if(boss.attackTimer>100){bossAttack();boss.attackTimer=0}if(boss.currentHealth<=0){boss.defeated=true;gameState.bossDefeated=true;gameState.score+=boss.score;gameState.stageFeathers+=boss.feathers;gameState.stageGoldenFeathers+=boss.goldenFeathers;createParticles(boss.x,boss.y,'#FF6B9D',30);showNotification('‚òÖ BOSS DEFEATED! ‚òÖ');setTimeout(()=>stageClear(),1500)}}projectiles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.2});projectiles=projectiles.filter(p=>p.y<500&&p.y>0);particles.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.vy+=0.1;p.life--;p.size*=0.98});particles=particles.filter(p=>p.life>0);poops.forEach(poop=>{humans.forEach(h=>{if(!h.hit&&collision(poop,h)){h.hit=true;poop.hit=true;const mult=gameState.combo>=20?3:gameState.combo>=10?2:gameState.combo>=5?1.5:1;gameState.score+=h.score*mult;gameState.hits++;gameState.combo++;gameState.stageFeathers+=1+Math.floor(gameState.combo/5);createParticles(h.x,h.y,'#8B4513',8)}});if(boss&&!boss.defeated&&collision(poop,boss)){boss.currentHealth--;poop.hit=true;gameState.hits++;createParticles(boss.x,boss.y,'#FF6B9D',10)}});poops=poops.filter(p=>!p.hit);projectiles.forEach(p=>{if(collision(p,bird)){p.hit=true;if(gameState.effects.shield){gameState.effects.shield=false;showNotification('SHIELD BREAK!');createParticles(bird.x,bird.y,'#00D4FF',15)}else if(gameState.effects.invincible<=0){gameState.health--;gameState.effects.invincible=60;gameState.combo=0;createParticles(bird.x,bird.y,'#EF4444',10);if(gameState.health<=0)gameOver()}}});projectiles=projectiles.filter(p=>!p.hit)}function shootPoop(){gameState.shots++;poops.push({x:bird.x,y:bird.y+30,width:24,height:24,speed:8,rotation:0})}function bossAttack(){if(!boss)return;for(let i=0;i<3;i++)setTimeout(()=>{if(boss&&!boss.defeated)projectiles.push({x:boss.x,y:boss.y-20,vx:(bird.x-boss.x)*0.025+(Math.random()-0.5)*3,vy:-7-Math.random()*3})},i*150)}function collision(a,b){const ax=a.x-(a.width||20)/2,ay=a.y-(a.height||20)/2,bx=b.x-b.width/2,by=b.y-b.height/2;return ax<bx+b.width&&ax+(a.width||20)>bx&&ay<by+b.height&&ay+(a.height||20)>by}function createParticles(x,y,color,count){for(let i=0;i<count;i++)particles.push({x,y,vx:(Math.random()-0.5)*8,vy:(Math.random()-0.5)*8-2,color,size:Math.random()*6+3,life:40+Math.random()*20})}function render(){const gradient=ctx.createLinearGradient(0,0,0,500);gradient.addColorStop(0,'#1a1a3e');gradient.addColorStop(0.5,'#0f0f2d');gradient.addColorStop(1,'#2d2d4a');ctx.fillStyle=gradient;ctx.fillRect(0,0,800,500);ctx.strokeStyle='rgba(168,85,247,0.1)';ctx.lineWidth=1;for(let i=0;i<17;i++){ctx.beginPath();ctx.moveTo(i*50,0);ctx.lineTo(i*50,500);ctx.stroke()}for(let i=0;i<11;i++){ctx.beginPath();ctx.moveTo(0,i*50);ctx.lineTo(800,i*50);ctx.stroke()}const time=Date.now()/1000;stars.forEach(s=>{const tw=Math.sin(time*2+s.twinkle)*0.5+0.5;ctx.fillStyle=`rgba(255,255,255,${0.3+tw*0.7})`;ctx.fillRect(s.x,s.y,s.size,s.size)});ctx.fillStyle='#0a0a1a';ctx.fillRect(50,280,50,80);ctx.fillRect(110,260,60,100);ctx.fillRect(450,270,55,90);ctx.fillRect(520,285,70,75);const colors=['#FF6B9D','#00D4FF','#A855F7','#FBBF24'];[[55,290],[75,290],[115,270],[145,270],[455,280],[480,280],[530,295],[570,295]].forEach((p,i)=>{ctx.fillStyle=colors[i%colors.length];ctx.shadowColor=colors[i%colors.length];ctx.shadowBlur=5;ctx.fillRect(p[0],p[1],10,12)});ctx.shadowBlur=0;ctx.fillStyle='#2d2d4a';ctx.fillRect(0,360,800,140);ctx.font='30px Arial';ctx.textAlign='center';humans.forEach(h=>{if(!h.hit){const emoji=h.type==='child'?'üßí':h.type==='drunk'?'üç∫':'üö∂';ctx.fillText(emoji,h.x,h.y)}});if(boss&&!boss.defeated){ctx.font='45px Arial';ctx.shadowColor='#FF6B9D';ctx.shadowBlur=20;ctx.fillText(gameState.currentStage===1?'üßπ':'üí™',boss.x,boss.y);ctx.shadowBlur=0;const bw=70;ctx.fillStyle='#1a1a2e';ctx.fillRect(boss.x-bw/2-2,boss.y-45,bw+4,10);ctx.fillStyle='#EF4444';ctx.fillRect(boss.x-bw/2,boss.y-43,bw*(boss.currentHealth/boss.health),6);ctx.fillStyle='#FF6B9D';ctx.font='7px "Press Start 2P"';ctx.fillText(boss.name,boss.x,boss.y-50)}const poopSprite=spriteCanvases['poop'];poops.forEach(p=>{ctx.save();ctx.translate(p.x,p.y);ctx.rotate(p.rotation);if(poopSprite)ctx.drawImage(poopSprite,-12,-12);ctx.restore()});ctx.font='18px Arial';projectiles.forEach(p=>ctx.fillText('üçæ',p.x,p.y));const birdSprite=spriteCanvases[BIRDS[gameState.currentBird].sprite];if(gameState.effects.invincible<=0||Math.floor(gameState.effects.invincible/5)%2===0){ctx.shadowColor='#00D4FF';ctx.shadowBlur=15;if(birdSprite)ctx.drawImage(birdSprite,bird.x-24,bird.y-24);ctx.shadowBlur=0}if(gameState.effects.shield){ctx.strokeStyle='#00D4FF';ctx.lineWidth=3;ctx.shadowColor='#00D4FF';ctx.shadowBlur=15;ctx.beginPath();ctx.arc(bird.x,bird.y,32,0,Math.PI*2);ctx.stroke();ctx.shadowBlur=0}particles.forEach(p=>{ctx.fillStyle=p.color;ctx.fillRect(p.x-p.size/2,p.y-p.size/2,p.size,p.size)});drawUI()}function drawUI(){const stage=STAGES[gameState.currentStage];ctx.fillStyle='rgba(13,2,33,0.9)';ctx.fillRect(0,0,800,38);ctx.strokeStyle='#A855F7';ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(0,38);ctx.lineTo(800,38);ctx.stroke();ctx.font='14px Arial';for(let i=0;i<gameState.maxHealth;i++){ctx.fillStyle=i<gameState.health?'#FF6B9D':'#374151';ctx.shadowColor=i<gameState.health?'#FF6B9D':'transparent';ctx.shadowBlur=i<gameState.health?8:0;ctx.fillText('‚ô•',12+i*22,26)}ctx.shadowBlur=0;ctx.fillStyle='#00D4FF';ctx.font='10px "Press Start 2P"';ctx.textAlign='left';ctx.fillText(`${gameState.score}`,100,24);if(gameState.combo>1){ctx.fillStyle='#FBBF24';ctx.font='9px "Press Start 2P"';ctx.fillText(`${gameState.combo}x`,190,24)}ctx.fillStyle='#E5E7EB';ctx.font='9px "Press Start 2P"';ctx.fillText(`ü™∂${gameState.feathers+gameState.stageFeathers}`,280,24);if(!gameState.bossSpawned){const rem=Math.max(0,stage.duration-gameState.time);ctx.fillStyle=rem<10?'#EF4444':'#A855F7';ctx.fillText(`‚è±${rem}`,400,24)}else if(!gameState.bossDefeated){ctx.fillStyle='#EF4444';ctx.fillText('‚öîBOSS',400,24)}ctx.fillStyle='#9CA3AF';ctx.font='7px "Press Start 2P"';ctx.fillText(`STG${gameState.currentStage}`,720,24);const gw=120,gx=550,gy=12;ctx.fillStyle='#1a1a2e';ctx.fillRect(gx,gy,gw,14);const isLax=gameState.effects.laxative>Date.now();ctx.fillStyle=isLax?'#A855F7':'#8B4513';ctx.fillRect(gx+2,gy+2,(gw-4)*(gameState.poopGauge/gameState.maxPoopGauge),10);ctx.strokeStyle=isLax?'#FF6B9D':'#A855F7';ctx.strokeRect(gx,gy,gw,14);let ey=50;ctx.font='7px "Press Start 2P"';ctx.textAlign='left';if(gameState.effects.laxative>Date.now()){ctx.fillStyle='#A855F7';ctx.fillText(`üíä${Math.ceil((gameState.effects.laxative-Date.now())/1000)}s`,10,ey);ey+=12}if(gameState.effects.shield){ctx.fillStyle='#00D4FF';ctx.fillText('üõ°Ô∏èON',10,ey)}}function stageClear(){gameState.screen='stageClear';const stage=STAGES[gameState.currentStage];let starCount=1;if(gameState.score>=stage.targetScore)starCount=2;if(gameState.score>=stage.targetScore&&gameState.health===gameState.maxHealth)starCount=3;if(starCount===3)gameState.stageGoldenFeathers+=3;gameState.stageStars[gameState.currentStage]=Math.max(gameState.stageStars[gameState.currentStage],starCount);gameState.feathers+=gameState.stageFeathers;gameState.goldenFeathers+=gameState.stageGoldenFeathers;hideAllOverlays();document.getElementById('stageClearOverlay').classList.add('active');document.getElementById('clearStars').textContent='‚òÖ'.repeat(starCount)+'‚òÜ'.repeat(3-starCount);document.getElementById('clearScore').textContent=gameState.score;document.getElementById('clearAccuracy').textContent=gameState.shots>0?Math.round(gameState.hits/gameState.shots*100)+'%':'0%';document.getElementById('clearFeathers').textContent=`ü™∂ ${gameState.stageFeathers}`;document.getElementById('clearGoldenFeathers').textContent=`‚ú¶ ${gameState.stageGoldenFeathers}`}function gameOver(){gameState.screen='gameover';gameState.feathers+=Math.floor(gameState.stageFeathers*0.5);hideAllOverlays();document.getElementById('gameoverOverlay').classList.add('active');document.getElementById('goScore').textContent=gameState.score;document.getElementById('goFeathers').textContent=`ü™∂ ${Math.floor(gameState.stageFeathers*0.5)}`}function showNotification(text){const n=document.getElementById('notification');n.textContent=text;n.classList.add('show');setTimeout(()=>n.classList.remove('show'),2000)}function gameLoop(){if(gameState.screen==='playing'){update();render();animationId=requestAnimationFrame(gameLoop)}}function init(){initSprites();resizeCanvas();gameState.maxPoopGauge=100+gameState.upgrades.poopCapacity*20;gameState.poopGauge=gameState.maxPoopGauge;generateStars();updateItemButtons();drawMenuBird()}init();